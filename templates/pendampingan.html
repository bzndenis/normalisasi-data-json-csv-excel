{% extends "base.html" %}

{% block title %}Manajemen Data Pendampingan - Data Normalization App{% endblock %}

{% block extra_css %}
<style>
/* Tab Styles from upload.html */
.tab-btn {
    flex: 1;
    padding: 1rem 2rem;
    border: none;
    background: transparent;
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
    color: var(--text-secondary, #6c757d);
    position: relative;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.tab-btn:hover {
    color: var(--primary-color, #0d6efd);
}

.tab-btn.active {
    color: var(--primary-color, #0d6efd);
}

.tab-btn.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--primary-color, #0d6efd);
    border-radius: 3px 3px 0 0;
}

.tab-content {
    display: none;
    padding: 1.5rem 0;
}

.tab-content.active {
    display: block;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Upload Area Styles */
.file-upload {
    border: 2px dashed #ddd;
    border-radius: 12px;
    padding: 3rem 2rem;
    text-align: center;
    background: #f8f9fa;
    transition: all 0.3s;
    cursor: pointer;
}

.file-upload:hover, .file-upload.dragover {
    border-color: var(--primary-color, #0d6efd);
    background: #e9ecef;
}

/* Stats Cards */
.stats-container {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin-top: 1.5rem;
}

.stat-card {
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 1.25rem;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}

.stat-number {
    font-size: 1.8rem;
    font-weight: 700;
    color: #212529;
    margin-bottom: 0.25rem;
}

.stat-label {
    font-size: 0.75rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}

/* Terminal Window */
.terminal-window {
    background: #1e1e1e;
    border-radius: 8px;
    padding: 0;
    margin-top: 1.5rem;
    border: 1px solid #333;
    font-family: 'Consolas', 'Monaco', monospace;
    overflow: hidden;
}

.terminal-header {
    background: #2d2d2d;
    padding: 0.5rem 1rem;
    display: flex;
    gap: 0.5rem;
    align-items: center;
    border-bottom: 1px solid #333;
}

.terminal-dot { width: 10px; height: 10px; border-radius: 50%; }
.dot-red { background: #ff5f56; }
.dot-yellow { background: #ffbd2e; }
.dot-green { background: #27c93f; }

.terminal-content {
    padding: 1rem;
    color: #d4d4d4;
    font-size: 0.85rem;
    height: 300px;
    max-height: 300px;
    overflow-y: auto;
    white-space: pre-wrap;
}

.log-line { margin-bottom: 0.2rem; }
.log-success { color: #4ade80; }
.log-error { color: #f87171; }
.log-info { color: #60a5fa; }

/* Responsive */
@media (max-width: 768px) {
    .stats-container { grid-template-columns: repeat(2, 1fr); }
}
</style>
{% endblock %}

{% block content %}
<div class="container" style="padding-top: 2rem; padding-bottom: 3rem;">
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom-0 text-center pb-0 pt-4">
            <h2 class="card-title fw-bold mb-1">Manajemen Data Pendampingan</h2>
            <p class="text-muted">Import, Validasi, dan Monitoring Kinerja Sistem</p>
        </div>
        
        <div class="card-body p-0">
            <!-- Tab Navigation -->
            <div style="display: flex; border-bottom: 1px solid #dee2e6; padding: 0 1rem;">
                <button class="tab-btn active" onclick="switchTab('import')" id="tab-import">
                    <i class="bi bi-cloud-arrow-up-fill"></i> Import Data
                </button>
                <button class="tab-btn" onclick="switchTab('validate')" id="tab-validate">
                    <i class="bi bi-shield-check-fill"></i> Validasi
                </button>
                <button class="tab-btn" onclick="switchTab('logs')" id="tab-logs">
                    <i class="bi bi-terminal-fill"></i> System Logs
                </button>
            </div>
            
            <div class="p-4">
                <!-- Import Panel -->
                <div id="content-import" class="tab-content active">
                    <form id="import-form">
                        <div class="file-upload" id="import-dropzone">
                            <i class="bi bi-cloud-upload" style="font-size: 3.5rem; color: var(--primary-color, #0d6efd); margin-bottom: 1rem;"></i>
                            <h4 class="mb-2">Drop file JSON di sini atau klik untuk upload</h4>
                            <p class="text-muted mb-4">Pastikan format JSON sesuai dengan template pendampingan</p>
                            
                            <input type="file" id="import-file" name="file" accept=".json" style="display: none;">
                            <button type="button" class="btn btn-primary" onclick="document.getElementById('import-file').click()">
                                <i class="bi bi-folder2-open"></i> Browse File
                            </button>
                        </div>
                        
                        <!-- File Info Block -->
                        <div id="import-file-info" class="alert alert-info mt-3 align-items-center" style="display: none;">
                            <i class="bi bi-file-earmark-check fs-4 me-2"></i>
                            <div>
                                <strong id="import-filename">No file selected</strong>
                            </div>
                        </div>

                        <!-- Preview Container -->
                        <div id="preview-container" style="display: none; margin-top: 1.5rem;">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h5 class="mb-1"><i class="bi bi-table"></i> Data Preview & Correction</h5>
                                    <small class="text-muted">Review data before processing. Edit cells directly.</small>
                                </div>
                            </div>

                            <!-- Column Mapping Section -->
                            <div id="mapping-section" style="display: none; background: #f8f9fa; padding: 1rem; border-radius: 8px; border: 1px solid #dee2e6; margin-bottom: 1rem;">
                                <h6 class="fw-bold mb-3"><i class="bi bi-diagram-3"></i> Map Source Columns to Required Fields</h6>
                                <div class="row" id="mapping-controls">
                                    <!-- Selects generated by JS -->
                                </div>
                            </div>
                            
                            <div id="preview-table-container" style="margin-bottom: 1rem; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden;"></div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-outline-secondary me-md-2" onclick="location.reload()">
                                    <i class="bi bi-x-circle"></i> Cancel
                                </button>
                                <button type="button" class="btn btn-primary" id="btn-process-preview">
                                    <i class="bi bi-rocket-takeoff"></i> Process Data Now
                                </button>
                            </div>
                        </div>
                        
                        <!-- Default Submit (Hidden when preview active) -->
                        <div class="text-center mt-4" id="default-actions" style="display: none;">
                             <!-- Kept for fallback logic, but usually we use preview flow -->
                        </div>
                    </form>
                    
                    <!-- Progress & Stats (Hidden Initially) -->
                    <div class="progress-wrapper" id="import-progress" style="display: none; margin-top: 2rem;">
                         <div class="d-flex justify-content-between mb-2">
                             <span class="text-muted"><i class="bi bi-gear-wide-connected spin"></i> Processing data...</span>
                             <span id="import-percent" class="fw-bold">0%</span>
                         </div>
                         <div class="progress" style="height: 10px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" id="import-bar" role="progressbar" style="width: 0%"></div>
                         </div>
                         
                         <!-- Stats -->
                         <div class="stats-container" id="import-stats" style="display: none;">
                            <div class="stat-card">
                                <div class="stat-number" id="stat-total">0</div>
                                <div class="stat-label">Total</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number text-success" id="stat-success">0</div>
                                <div class="stat-label">Success</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number text-primary" id="stat-created">0</div>
                                <div class="stat-label">New Users</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number text-danger" id="stat-failed">0</div>
                                <div class="stat-label">Failed</div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-center mt-3">
                             <a id="download-failed-btn" href="#" class="btn btn-danger" style="display: none;">
                                <i class="bi bi-file-earmark-arrow-down"></i> Download Failed Report
                            </a>
                        </div>
                        
                        <!-- Log Window -->
                        <div class="terminal-window" id="import-log-window">
                            <div class="terminal-header">
                                <div class="terminal-dot dot-red"></div>
                                <div class="terminal-dot dot-yellow"></div>
                                <div class="terminal-dot dot-green"></div>
                                <span style="margin-left: 10px; font-size: 0.8rem; color: #888;">console output</span>
                            </div>
                            <div class="terminal-content" id="import-log"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Validate Panel -->
                <div id="content-validate" class="tab-content">
                     <div class="alert alert-light border mb-4">
                        <i class="bi bi-info-circle me-2"></i>
                        Upload file JSON referensi untuk membandingkan data dengan database dan menemukan inkonsistensi.
                    </div>
                
                    <form id="validate-form">
                        <div class="file-upload" id="validate-dropzone">
                            <i class="bi bi-search" style="font-size: 3rem; color: #6c757d; margin-bottom: 1rem;"></i>
                            <h5 class="mb-2">Pilih File Referensi</h5>
                             <input type="file" id="validate-file" name="file" accept=".json" style="display: none;">
                            <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('validate-file').click()">
                                Browse File
                            </button>
                            <div id="validate-filename" class="mt-2 text-success fw-bold"></div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card bg-light border-0">
                                    <div class="card-body">
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="check-fix" name="fix">
                                            <label class="form-check-label" for="check-fix">Auto-Fix (Insert Missing)</label>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="check-dry-run" name="dry_run">
                                            <label class="form-check-label" for="check-dry-run">Dry Run (Simulasi)</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 d-flex align-items-center">
                                <button type="submit" class="btn btn-success w-100 py-3" id="btn-validate">
                                    <i class="bi bi-search"></i> Jalankan Validasi
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <div class="terminal-window" id="validate-log-window" style="display: none;">
                        <div class="terminal-header">
                            <span style="font-size: 0.8rem; color: #888;">validation results</span>
                        </div>
                        <div class="terminal-content" id="validate-log">Waiting for input...</div>
                    </div>
                </div>
                
                <!-- Logs Panel -->
                <div id="content-logs" class="tab-content">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                         <h5 class="mb-0">Activity Logs</h5>
                         <button class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                    </div>
                    <div class="terminal-window" style="display: block; margin-top: 0;">
                        <div class="terminal-header">
                             <span style="font-size: 0.8rem; color: #888;">root@server:~/logs</span>
                        </div>
                        <div class="terminal-content">
                            <div class="log-line log-info">[INFO] System active</div>
                            <div class="log-line">[INFO] Monitoring imports...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("Pendampingan Page Script Loaded");

    // Tab Switching
    window.switchTab = function(tab) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById('content-' + tab).classList.add('active');
    };

    // Preview Logic States
    let previewData = [];
    let rawImportData = [];
    let currentMapping = {};
    
    // System Standard Keys (Target)
    const REQUIRED_KEYS = {
        'NO': { key: 'no', required: false },
        'NAMA PENDAMPING': { key: 'nama_pendamping', required: true },
        'EMAIL': { key: 'email', required: true },
        'NO SK KPS': { key: 'no_sk_kps', required: true },
        'SKEMA PS': { key: 'skema_ps', required: false },
        'TAHUN PENDAMPINGAN': { key: 'tahun_pendampingan', required: false },
        'KPS': { key: 'kps', required: false },
        'PROVINSI': { key: 'provinsi', required: false },
        'KABUPATEN/KOTA': { key: 'kabupaten', required: false },
        'KECAMATAN': { key: 'kecamatan', required: false },
        'DESA/KELURAHAN': { key: 'desa', required: false }
    };

    // File Processing (Preview)
    function handleFile(file) {
        console.log("Handling file:", file);
        if (!file) return;
        
        // Show info
        const infoBlock = document.getElementById('import-file-info');
        const filenameSpan = document.getElementById('import-filename');
        
        if(infoBlock) {
            infoBlock.style.display = 'flex';
            infoBlock.className = 'alert alert-info mt-3 d-flex align-items-center';
        }
        if(filenameSpan) {
            filenameSpan.innerHTML = `${file.name} <span class="spinner-border spinner-border-sm ms-2"></span> parsing...`;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            console.log("File read complete");
            try {
                const json = JSON.parse(e.target.result);
                if (Array.isArray(json) && json.length > 0) {
                    rawImportData = json;
                    
                    // Detect Available Headers from first row
                    const sourceHeaders = Object.keys(json[0]);
                    
                    renderMappingControls(sourceHeaders);
                    updatePreviewFromMapping();
                    
                    document.getElementById('preview-container').style.display = 'block';
                    document.getElementById('import-dropzone').style.display = 'none'; // Hide dropzone during preview
                    
                    if(filenameSpan) filenameSpan.innerHTML = `<strong>${file.name}</strong> - ${json.length} Records Loaded`;
                    if(infoBlock) infoBlock.className = 'alert alert-success mt-3 d-flex align-items-center';
                } else {
                    alert('Format JSON harus berupa Array of Objects dan tidak boleh kosong');
                    if(infoBlock) infoBlock.style.display = 'none';
                }
            } catch (err) {
                console.error("JSON Parse Error:", err);
                alert('Gagal parsing JSON: ' + err.message);
                if(infoBlock) infoBlock.style.display = 'none';
            }
        };
        reader.readAsText(file);
    }

    // Input Change Listeners
    const importInput = document.getElementById('import-file');
    if(importInput) {
        importInput.addEventListener('change', function(e) {
            console.log("Import file changed");
            handleFile(this.files[0]);
            this.value = ''; // Allow re-selecting the same file
        });
    }

    const validateInput = document.getElementById('validate-file');
    if(validateInput) {
        validateInput.addEventListener('change', function(e) {
            if(this.files[0]) {
                 document.getElementById('validate-filename').textContent = this.files[0].name;
            }
        });
    }

    // Drag & Drop
    ['import', 'validate'].forEach(type => {
        const dropzone = document.getElementById(type + '-dropzone');
        if(!dropzone) return;
        
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });
        dropzone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
        });
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            
            if (type === 'import') {
                document.getElementById('import-file').files = e.dataTransfer.files;
                handleFile(file);
            } else {
                document.getElementById('validate-file').files = e.dataTransfer.files;
                document.getElementById('validate-filename').textContent = file.name;
            }
        });
    });

    // Render Mapping UI (Dropdowns)
    function renderMappingControls(sourceHeaders) {
        const container = document.getElementById('mapping-controls');
        if(!container) return;
        
        container.innerHTML = '';
        currentMapping = {};
        
        Object.keys(REQUIRED_KEYS).forEach(targetKey => {
            const config = REQUIRED_KEYS[targetKey];
            const isReq = config.required;
            
            // Auto-match logic
            const normalizedTarget = targetKey.toLowerCase().replace(/[^a-z0-9]/g, '');
            let bestMatch = '';
            
            // Priority 1: Exact Match
            if (sourceHeaders.includes(targetKey)) {
                bestMatch = targetKey;
            } else {
                // Priority 2: Fuzzy Match
                const match = sourceHeaders.find(h => {
                    const normalizedSource = h.toLowerCase().replace(/[^a-z0-9]/g, '');
                    return normalizedSource === normalizedTarget || 
                           normalizedSource.includes(normalizedTarget) || 
                           normalizedTarget.includes(normalizedSource);
                });
                if (match) bestMatch = match;
            }
            
            // Set initial mapping
            currentMapping[targetKey] = bestMatch; 
            
            // Create UI Element
            const div = document.createElement('div');
            div.className = 'col-md-3 mb-3';
            
            let options = `<option value="">-- Pilih Kolom --</option>`;
            sourceHeaders.forEach(h => {
                const selected = h === bestMatch ? 'selected' : '';
                options += `<option value="${h}" ${selected}>${h}</option>`;
            });
            
            div.innerHTML = `
                <label class="form-label small fw-bold mb-1">
                    ${targetKey} ${isReq ? '<span class="text-danger">*</span>' : ''}
                </label>
                <select class="form-select form-select-sm border-secondary mapping-select" 
                        data-target="${targetKey}" 
                        onchange="handleMappingChange(this)">
                    ${options}
                </select>
            `;
            container.appendChild(div);
        });
        
        const mappingSection = document.getElementById('mapping-section');
        if(mappingSection) mappingSection.style.display = 'block';
    }

    // Handle Dropdown Change
    window.handleMappingChange = function(selectInfo) {
        const target = selectInfo.getAttribute('data-target');
        const source = selectInfo.value;
        currentMapping[target] = source;
        updatePreviewFromMapping();
    };

    // Regenerate Preview Data based on Mapping
    function updatePreviewFromMapping() {
        if (!rawImportData || rawImportData.length === 0) return;
        
        let invalidCount = 0;
        
        previewData = rawImportData.map(row => {
            const newRow = {};
            Object.keys(currentMapping).forEach(targetKey => {
                const sourceKey = currentMapping[targetKey];
                newRow[targetKey] = sourceKey ? (row[sourceKey] || '') : '';
            });
            
            // Check validity
            if (!newRow['EMAIL'] || !newRow['NO SK KPS']) {
                invalidCount++;
            }
            
            return newRow;
        });
        
        renderPreviewTable(previewData, invalidCount);
    }

    // Render Table
    function renderPreviewTable(data, invalidCount = 0) {
        const container = document.getElementById('preview-table-container');
        if (!container || !data || data.length === 0) return;
        
        const headers = Object.keys(REQUIRED_KEYS);
        
        let html = ``;
        
        if (invalidCount > 0) {
            html += `
            <div class="alert alert-danger mb-3 d-flex align-items-center">
                <i class="bi bi-exclamation-octagon-fill fs-3 me-3"></i>
                <div>
                    <strong>Attention Needed:</strong> ${invalidCount} records found with missing mandatory fields (EMAIL or NO SK KPS).<br>
                    <small>These records will be marked as FAILED during import. Please check your column mapping or source file.</small>
                </div>
            </div>`;
        }

        html += `
        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
            <table class="table table-striped table-hover table-sm mb-0" style="font-size: 0.85rem;">
                <thead class="table-dark" style="position: sticky; top: 0; z-index: 10;">
                    <tr>
                        <th style="width: 50px;">#</th>
        `;
        
        headers.forEach(key => {
            html += `<th>${key}</th>`;
        });
        html += `</tr></thead><tbody>`;
        
        const limit = Math.min(data.length, 100);
        
        for (let i = 0; i < limit; i++) {
            const row = data[i];
            const hasEmail = !!row['EMAIL'];
            const hasNoSk = !!row['NO SK KPS'];
            const isMissing = !hasEmail || !hasNoSk;
            
            html += `<tr class="${isMissing ? 'table-danger' : ''}">`;
            html += `<td>${i + 1}</td>`;
            
            headers.forEach(key => {
                const val = row[key] || '';
                const isRequired = REQUIRED_KEYS[key].required;
                const isCellMissing = isRequired && !val;
                const cellStyle = isCellMissing ? 'background-color: #ffcccc;' : '';
                
                html += `
                    <td contenteditable="true" 
                        onblur="updatePreviewData(${i}, '${key}', this.innerText)"
                        style="${cellStyle}; min-width: 150px;">
                        ${val}
                    </td>`;
            });
            html += `</tr>`;
        }
        
        html += `</tbody></table></div>`;
        
        let footerText = `Showing first ${limit} of ${data.length} records.`;
        if (data.length > limit) footerText += ` (Full data will be processed)`;
        
        if (data.length > 500) {
            html += `<div class="p-2 bg-warning bg-opacity-10 text-warning"><i class="bi bi-exclamation-triangle"></i> ${footerText}</div>`;
        } else {
             html += `<div class="p-2 text-muted small"><i class="bi bi-info-circle"></i> ${footerText}</div>`;
        }
        
        container.innerHTML = html;
    }

    // Exposed for contenteditable (attached to window)
    window.updatePreviewData = function(index, key, value) {
        if (previewData[index]) {
            previewData[index][key] = value.trim();
        }
    };

    // Log Helper
    function formatLogLine(line) {
        if (line.toLowerCase().includes('error') || line.toLowerCase().includes('fail')) return `<div class="log-line log-error">${line}</div>`;
        if (line.toLowerCase().includes('success') || line.toLowerCase().includes('created')) return `<div class="log-line log-success">${line}</div>`;
        return `<div class="log-line">${line}</div>`;
    }

    // Process Data (Submit)
    const btnProcess = document.getElementById('btn-process-preview');
    if(btnProcess) {
        btnProcess.addEventListener('click', async function() {
            if (previewData.length === 0) return;
            if (!confirm(`Ready to process ${previewData.length} records?`)) return;
            
            const btn = this;
            const progressWrapper = document.getElementById('import-progress');
            const progressBar = document.getElementById('import-bar');
            const progressPercent = document.getElementById('import-percent');
            const logContent = document.getElementById('import-log');
            const statsContainer = document.getElementById('import-stats');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';
            document.getElementById('preview-container').style.display = 'none';
            if(progressWrapper) progressWrapper.style.display = 'block';
            if(statsContainer) statsContainer.style.display = 'none';
            
            if(logContent) logContent.innerHTML = '<div class="log-line log-info">Packing and sending data...</div>';
            if(progressBar) progressBar.style.width = '0%';
            
            try {
                const jsonString = JSON.stringify(previewData);
                const blob = new Blob([jsonString], { type: "application/json" });
                const formData = new FormData();
                formData.append('file', blob, 'import_data.json');
                
                const response = await fetch('/pendampingan/import', {
                    method: 'POST',
                    body: formData
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    const text = decoder.decode(value);
                    const lines = text.split('\n');
                    
                    for (const line of lines) {
                        if (line.trim().startsWith('data: ')) {
                            const jsonStr = line.replace('data: ', '').trim();
                            if (!jsonStr) continue;
                            
                            try {
                                const data = JSON.parse(jsonStr);
                                
                                if (data.progress !== undefined && progressBar) {
                                    progressBar.style.width = data.progress + '%';
                                    progressPercent.textContent = data.progress + '%';
                                }
                                
                                if (data.log && logContent) {
                                    logContent.innerHTML += formatLogLine(data.log);
                                    logContent.scrollTop = logContent.scrollHeight;
                                }
                                
                                if (data.stats && statsContainer) {
                                    statsContainer.style.display = 'grid';
                                    document.getElementById('stat-total').textContent = data.stats.total;
                                    document.getElementById('stat-success').textContent = data.stats.success;
                                    document.getElementById('stat-created').textContent = data.stats.created || 0;
                                    document.getElementById('stat-failed').textContent = data.stats.failed;
                                }
                                
                                if (data.failed_report_url) {
                                    const btnDownload = document.getElementById('download-failed-btn');
                                    if(btnDownload) {
                                        btnDownload.href = "/pendampingan" + data.failed_report_url; 
                                        btnDownload.style.display = 'inline-block';
                                    }
                                    if(logContent) logContent.innerHTML += `<div class="log-line log-error">Report Reference generated.</div>`;
                                }
                            } catch (e) {
                                console.error('JSON Parse error', e);
                            }
                        }
                    }
                }
            } catch (error) {
                if(logContent) logContent.innerHTML += `<div class="log-line log-error">Network/Server Error: ${error.message}</div>`;
            } finally {
                btn.innerHTML = '<i class="bi bi-check-lg"></i> Completed';
            }
        });
    }

    // Validasi Submit
    const validateForm = document.getElementById('validate-form');
    if(validateForm) {
        validateForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            formData.append('fix', document.getElementById('check-fix').checked);
            formData.append('dry_run', document.getElementById('check-dry-run').checked);
            
            const btn = document.getElementById('btn-validate');
            const logWindow = document.getElementById('validate-log-window');
            const logContent = document.getElementById('validate-log');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Verifying...';
            logWindow.style.display = 'block';
            logContent.innerHTML = '<div class="log-line log-info">Starting validation...</div>';
            
            try {
                const response = await fetch('/pendampingan/validate', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                logContent.innerHTML += `<div class="log-line log-success">Validation Complete!</div>`;
                logContent.innerHTML += `<pre style="color: #ccc; margin-top: 10px;">${JSON.stringify(result, null, 2)}</pre>`;
                
            } catch (error) {
                logContent.innerHTML += `<div class="log-line log-error">Error: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-search"></i> Jalankan Validasi';
            }
        });
    }
});
</script>
{% endblock %}
